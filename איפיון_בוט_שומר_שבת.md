# מסמך איפיון - בוט "שומר שבת" לטלגרם

## תיאור כללי

בוט אוטומטי לטלגרם שמטרתו לנעול קבוצות בכניסת שבת ולפתוח אותן בצאת השבת באופן אוטומטי, לפי זמנים מדויקים בהתאם למיקום הגיאוגרפי של הקבוצה.

---

## 1. תכונות ליבה

### 1.1 נעילה ופתיחה אוטומטית של קבוצות

#### תיאור
הבוט נועל ופותח קבוצות טלגרם באופן אוטומטי בזמנים מדויקים.

#### יכולות
- **נעילת קבוצה בכניסת שבת**
  - הקבוצה ננעלת בזמן הדלקת הנרות
  - חסימת שליחת הודעות רגילות, מדיה, סקרים, ועוד
  - אפשרות שליחת הודעות רק למנהלי הקבוצה
  
- **פתיחת קבוצה בצאת השבת**
  - הקבוצה נפתחת בזמן ההבדלה
  - החזרת כל ההרשאות לכלל המשתמשים
  - אפשרות שליחת כל סוגי התוכן

- **הודעות אוטומטיות**
  - שליחת הודעה מותאמת אישית בעת נעילה
  - שליחת הודעה מותאמת אישית בעת פתיחה

#### סוגי הרשאות שנשלטות
- שליחת הודעות טקסט
- שליחת תמונות
- שליחת סרטונים
- שליחת קבצי אודיו
- שליחת מסמכים
- שליחת הודעות קוליות
- שליחת סקרים
- הוספת תצוגות מקדימות של קישורים
- שליחת סטיקרים ו-GIF

---

### 1.2 חישוב זמני שבת

#### תיאור
הבוט מחשב באופן אוטומטי את זמני כניסת ויציאת השבת בהתאם למיקום הגיאוגרפי.

#### יכולות
- **משיכת זמנים מדויקים** לפי מיקום גיאוגרפי (דרך GeoNames ID)
- **תמיכה בכל מיקום בעולם** שבו יש זמני שבת
- **חישוב אוטומטי של זמן הבדלה** (צאת שלושה כוכבים)
- **התאמה לזמנים שונים במיקומים שונים** - לכל קבוצה יכול להיות מיקום משלה

#### פרמטרים הניתנים להתאמה
- **דקות לפני שקיעה להדלקת נרות** (ברירת מחדל: 18 דקות)
- **דקות אחרי שקיעה להבדלה** (ברירת מחדל: חישוב אוטומטי לפי 3 כוכבים)
- **זיהוי מיקום** דרך GeoName ID

#### זיהוי חגים
- הבוט מזהה שבתות עם שמות מיוחדים (למשל: "פרשת בראשית")
- תמיכה בזמני חגים המחוברים לשבת

---

### 1.3 תזמון ורענון אוטומטי

#### תיאור
הבוט מתזמן את כל הפעולות מראש ומרענן אותן באופן אוטומטי.

#### יכולות
- **תזמון נעילה ופתיחה** בעת הפעלת הבוט
- **רענון שבועי אוטומטי** - לאחר כל שבת, הבוט מתזמן אוטומטית את השבת הבאה
- **ניסיון חוזר במקרה של כשל** - אם משיכת הזמנים נכשלה, הבוט ינסה שוב אוטומטית
- **תזמון עצמאי לכל קבוצה** - כל קבוצה מקבלת תזמון משלה ללא תלות באחרות

#### תהליך רענון
1. בצאת השבת (23:00 מקומי)
2. הבוט מושך אוטומטית את זמני השבת הבאה
3. מתזמן את הנעילה והפתיחה החדשות
4. ממשיך את התהליך מדי שבוע

---

## 2. ניהול רב-קבוצות

### 2.1 תמיכה במספר קבוצות במקביל

#### תיאור
הבוט יכול לנהל מספר בלתי מוגבל של קבוצות בו-זמנית.

#### יכולות
- **קבוצות עם מיקומים שונים** - כל קבוצה יכולה להיות במיקום גיאוגרפי אחר
- **הגדרות עצמאיות לכל קבוצה**:
  - מיקום ייחודי
  - זמני הדלקה והבדלה ייחודיים
  - הודעות ייחודיות
- **תזמון עצמאי** - כל קבוצה מקבלת תזמון משלה
- **ניהול מרכזי** - כל הקבוצות מנוהלות דרך אותה אינסטנס של הבוט

---

### 2.2 שלושה מצבי תצורה

#### מצב א: קבוצה יחידה (פשוט)
- הגדרת קבוצה אחת דרך משתני סביבה בסיסיים
- מתאים למי שצריך בוט לקבוצה אחת בלבד
- קל וזריז להגדרה

#### מצב ב: ריבוי קבוצות מוגדרות מראש
- הגדרת מספר קבוצות דרך תצורה מובנית
- מתאים לארגונים או מי שמנהל מספר קבוצות
- כל ההגדרות נעשות מחוץ לטלגרם

#### מצב ג: דינמי מלא
- הוספת קבוצות דרך פקודות בטלגרם
- אין צורך להגדיר קבוצות מראש
- מנהל הקבוצה מגדיר את ההגדרות בעצמו
- שמירת ההגדרות באופן קבוע

---

## 3. פקודות משתמש

### 3.1 פקודות כלליות (זמינות לכל המשתמשים)

#### `/start`
- הצגת הודעת ברוכים הבאים
- מידע בסיסי על הבוט
- רשימת פקודות זמינות

#### `/times`
- הצגת זמני השבת הקרובה
- כולל: תאריך ושעה של הדלקת נרות והבדלה
- הצגת שם המיקום
- הצגת שם השבת/החג (אם רלוונטי)

#### `/status`
- הצגת סטטוס הבוט הנוכחי
- תצוגת התזמונים הקרובים:
  - מתי הנעילה הבאה
  - מתי הפתיחה הבאה
  - מתי הרענון השבועי הבא
- הצגת המיקום הנוכחי
- אינדיקציה האם הבוט מוגדר נכון

#### `/help`
- מדריך שימוש כללי
- הסבר מה הבוט עושה
- תשובות לשאלות נפוצות
- מידע ליצירת קשר לתמיכה

---

### 3.2 פקודות אדמין (זמינות רק למנהלי הקבוצה)

#### `/lock`
**מטרה**: נעילה ידנית של הקבוצה

**שימושים**:
- שבת שנכנסת מוקדם (ערב חג)
- מצב חירום שדורש סגירת הקבוצה
- בדיקת תקינות הבוט
- שבת שמתחילה בזמן לא סטנדרטי

#### `/unlock`
**מטרה**: פתיחה ידנית של הקבוצה

**שימושים**:
- פתיחה חריגה בשעת חירום
- טעות בהגדרות שגרמה לנעילה מוקדמת
- בדיקת תקינות הבוט
- מצבים מיוחדים (מוצ"ש מוקדם וכו')

#### `/settings`
**מטרה**: הצגת כל ההגדרות הנוכחיות של הקבוצה

**מידע שמוצג**:
- מיקום גיאוגרפי ו-GeoName ID
- דקות הדלקת נרות לפני שקיעה
- דקות הבדלה אחרי שקיעה
- הודעת נעילה
- הודעת פתיחה

#### `/setgeo <GEONAME_ID> [שם-מיקום]`
**מטרה**: הגדרת מיקום לקבוצה

**פרמטרים**:
- `GEONAME_ID` (חובה) - מזהה המיקום מ-GeoNames
- `שם-מיקום` (אופציונלי) - שם תצוגה למיקום

**השפעה**:
- שינוי מיקום הקבוצה
- עדכון אוטומטי של זמני השבת
- תזמון מחדש של נעילות ופתיחות

#### `/setoffsets <CANDLE_MIN> [HAVDALAH_MIN]`
**מטרה**: הגדרת זמני הדלקה והבדלה

**פרמטרים**:
- `CANDLE_MIN` (חובה) - דקות לפני שקיעה להדלקת נרות
- `HAVDALAH_MIN` (אופציונלי) - דקות אחרי שקיעה להבדלה (0 = אוטומטי)

**דוגמאות**:
- `/setoffsets 20` - הדלקה 20 דקות לפני, הבדלה אוטומטית
- `/setoffsets 18 50` - הדלקה 18 דקות לפני, הבדלה 50 דקות אחרי

**השפעה**:
- עדכון הזמנים עבור השבת הבאה
- תזמון מחדש

#### `/setmessages <LOCK> || <UNLOCK>`
**מטרה**: הגדרת הודעות מותאמות אישית

**פורמט**:
הודעת נעילה ופתיחה מופרדות ב-`||`

**דוגמאות**:
- `/setmessages 🕯️ שבת שלום! || ✨ שבוע טוב!`
- `/setmessages ערב שבת טוב מכולם 🌙 || מוצאי שבת מבורך 🌟`

**השפעה**:
- שינוי ההודעות שישלחו בנעילה ופתיחה הבאות

#### `/admin_help`
**מטרה**: מדריך מפורט לפקודות אדמין

**מידע**:
- הסבר מפורט על כל פקודת אדמין
- דוגמאות שימוש
- טיפים ושימושים מומלצים

---

## 4. בקרת הרשאות ואבטחה

### 4.1 הפרדת הרשאות

#### משתמשים רגילים
- צפייה במידע (times, status, help)
- אין אפשרות לשנות הגדרות
- אין אפשרות לנעול/לפתוח ידנית

#### מנהלי קבוצה (Admins)
- כל ההרשאות של משתמשים רגילים
- שינוי הגדרות הקבוצה
- נעילה ופתיחה ידנית
- שינוי מיקום, זמנים, והודעות

### 4.2 אימות הרשאות

#### תהליך בדיקה
- הבוט בודק אוטומטית את תפקיד המשתמש בקבוצה
- רק משתמשים עם תפקיד "מנהל" או "יוצר הקבוצה" יכולים להפעיל פקודות אדמין
- במקרה של ניסיון לא מורשה - הצגת הודעת שגיאה

#### הודעות שגיאה
- "⛔ פקודה זו זמינה רק לאדמינים של הקבוצה"

---

## 5. אחסון והגדרות

### 5.1 אחסון הגדרות דינמי

#### תיאור
הבוט שומר הגדרות של קבוצות שנוספו דרך פקודות טלגרם.

#### יכולות
- **שמירה קבועה** - הגדרות נשמרות לצמיתות
- **שחזור אוטומטי** - בעת הפעלה מחדש של הבוט, ההגדרות נטענות אוטומטית
- **עדכון בזמן אמת** - שינויים נשמרים מיד

#### מידע שנשמר לכל קבוצה
- מזהה הקבוצה (Chat ID)
- מיקום גיאוגרפי (GeoName ID ושם)
- זמני הדלקה והבדלה
- הודעות נעילה ופתיחה

---

### 5.2 שלושה מקורות להגדרות

#### 1. משתני סביבה בסיסיים
- מתאים לקבוצה יחידה
- הגדרה פשוטה
- ערכים: TOKEN, CHAT_ID, GEONAME_ID, וכו'

#### 2. משתנה סביבה מורכב (JSON)
- מתאים למספר קבוצות
- כל ההגדרות במקום אחד
- פורמט מובנה

#### 3. אחסון דינמי (קובץ JSON)
- מתאים לקבוצות שמוגדרות דרך הבוט
- עדכון דינמי
- שמירה אוטומטית

---

### 5.3 מיזוג הגדרות

#### לוגיקה
- הבוט מאחד הגדרות מכל המקורות
- הגדרות דינמיות (מקובץ) גוברות על הגדרות סטטיות (משתני סביבה)
- כל קבוצה מקבלת את ההגדרות המתאימות לה

---

## 6. ממשק משתמש וחוויית שימוש

### 6.1 הודעות ברורות

#### עקרונות
- שימוש באימוג'ים לזיהוי מהיר
- הודעות בעברית ברורה
- מידע מאורגן ומובנה

#### סוגי הודעות
- **הודעות מידע** (✅) - פעולה הצליחה
- **הודעות שגיאה** (❌) - משהו השתבש
- **הודעות אזהרה** (⚠️) - נדרש תשומת לב
- **הודעות סטטוס** (🤖, ⏰, 📍) - מידע כללי

### 6.2 הודעות נעילה ופתיחה

#### ברירות מחדל
- **נעילה**: "🕯️ שבת שלום! הקבוצה ננעלת עד צאת השבת."
- **פתיחה**: "✨ שבוע טוב! הקבוצה נפתחה."

#### אפשרויות התאמה
- ניתן לשנות לכל טקסט רצוי
- תמיכה באימוג'ים
- תמיכה בשורות מרובות
- תמיכה בפורמט מיוחד (Markdown)

---

### 6.3 מענה על שגיאות

#### מצבים שונים
- **קבוצה לא מוגדרת**: הצעה להגדיר מיקום עם `/setgeo`
- **משיכת זמנים נכשלה**: הודעת שגיאה והנחיה לנסות שוב
- **הרשאות חסרות**: הסבר שהפקודה דורשת הרשאות אדמין
- **פרמטרים שגויים**: הצגת דוגמת שימוש נכונה

---

## 7. אינטגרציות חיצוניות

### 7.1 Hebcal API

#### תיאור
שירות חיצוני למשיכת זמני שבת וחגים יהודיים.

#### שימוש
- משיכת זמני הדלקת נרות והבדלה
- זיהוי חגים ושבתות מיוחדות
- תמיכה בכל מיקום בעולם

#### פרמטרים שנשלחים
- מזהה GeoName
- הגדרות זמן הבדלה (דקות או אוטומטי)

---

### 7.2 GeoNames

#### תיאור
שירות לזיהוי מיקומים גיאוגרפיים ברחבי העולם.

#### שימוש
- זיהוי מיקומים לצורך חישוב זמני שבת
- כל עיר מקבלת מזהה ייחודי (GeoName ID)

#### דרישה מהמשתמש
- משתמש צריך למצוא את ה-GeoName ID של המיקום שלו
- הבוט לא מחפש את המיקום אוטומטית (אפשר לשפר בעתיד)

---

## 8. פריסה ותפעול

### 8.1 דרישות תשתית

#### סביבת ריצה
- צריך לרוץ 24/7 (בוט שמתזמן פעולות)
- לא Web Service - Background Worker
- צריך חיבור לאינטרנט קבוע

#### תלויות טכנולוגיות
- Python
- Telegram Bot API
- חיבור ל-Hebcal API
- מערכת תזמון (Scheduler)

---

### 8.2 הגדרה ראשונית

#### שלבים נדרשים
1. **יצירת בוט בטלגרם** - דרך BotFather
2. **הוספת הבוט לקבוצה**
3. **מתן הרשאות אדמין לבוט** במיוחד:
   - Change Group Info
   - Delete Messages  
   - Restrict Members
4. **הגדרת משתני סביבה**:
   - טוקן הבוט (חובה)
   - הגדרות קבוצה (אופציונלי - ניתן להגדיר דרך הבוט)
5. **הפעלת הבוט**

---

### 8.3 מעקב ולוגים

#### מידע שהבוט מדווח
- הודעות התחלה והפעלה
- חיבור מוצלח לטלגרם (כולל שם המשתמש של הבוט)
- טעינת הגדרות קבוצות
- תזמון נעילה ופתיחה (זמנים מדויקים)
- ביצוע פעולות נעילה ופתיחה
- שגיאות (אם יש)

#### רמות לוגים
- מידע כללי (INFO)
- שגיאות (ERROR)
- הצלחות (SUCCESS)

---

## 9. מקרי שימוש

### 9.1 משפחה עם קבוצה אחת

**תיאור**: משפחה שרוצה שהקבוצה שלה תהיה שקטה בשבת.

**צרכים**:
- קבוצה אחת בלבד
- מיקום קבוע
- ללא צורך בשינויים תכופים

**מצב תצורה**: מצב א - קבוצה יחידה

---

### 9.2 קהילה עם מספר קבוצות במיקומים שונים

**תיאור**: קהילה עם קבוצות בערים שונות.

**צרכים**:
- מספר קבוצות
- כל קבוצה במיקום אחר
- זמנים שונים לכל קבוצה
- ניהול מרכזי

**מצב תצורה**: מצב ב - ריבוי קבוצות מוגדרות מראש

---

### 9.3 ארגון עם קבוצות דינמיות

**תיאור**: ארגון שמוסיף קבוצות חדשות לפי הצורך.

**צרכים**:
- הוספת קבוצות דינמית
- מנהל כל קבוצה מגדיר בעצמו
- אין צורך בגישה למערכת מרכזית

**מצב תצורה**: מצב ג - דינמי מלא

---

### 9.4 מנהל קבוצה בשבת ערב חג

**תיאור**: שבת שנכנסת מוקדם יותר.

**צרכים**:
- סגירה ידנית מוקדמת
- עדכון זמני הדלקה למקרה חד-פעמי

**פתרון**: 
- שימוש ב-`/lock` לנעילה ידנית מוקדמת
- או עדכון זמנים ב-`/setoffsets` זמנית

---

### 9.5 בדיקת תקינות הבוט

**תיאור**: וידוא שהבוט עובד כהלכה.

**צרכים**:
- בדיקת נעילה ופתיחה
- צפייה בסטטוס ותזמונים

**פתרון**:
- `/status` לצפייה בתזמונים
- `/settings` לבדיקת הגדרות
- `/lock` ו-`/unlock` לבדיקה מעשית

---

## 10. תרחישי קצה

### 10.1 הבוט מופעל מחדש בשבת

**התנהגות**:
- הבוט נטען עם כל ההגדרות הקיימות
- בודק אם השבת כבר התחילה
- לא מנסה לנעול שוב (כי זה כבר עבר)
- מתזמן רק פעולות עתידיות

---

### 10.2 שגיאה במשיכת זמני שבת

**התנהגות**:
- רישום שגיאה ללוג
- ניסיון חוזר אחרי שעה
- הודעה למשתמשים במקרה של שאילתה

---

### 10.3 קבוצה ללא הגדרות

**התנהגות**:
- הבוט ממשיך לרוץ
- מציג הודעות שהקבוצה לא מוגדרת
- מנחה להגדיר עם `/setgeo`

---

### 10.4 משתמש לא מורשה מנסה פקודת אדמין

**התנהגות**:
- בדיקת הרשאות אוטומטית
- הצגת הודעה: "⛔ פקודה זו זמינה רק לאדמינים"
- הפעולה לא מתבצעת

---

## 11. יתרונות המערכת

### 11.1 אוטומציה מלאה
- אין צורך בהתערבות ידנית שבועית
- הבוט "זוכר" ועושה הכל בעצמו
- משחרר זמן ומאמץ

### 11.2 דיוק
- זמנים מדויקים לפי מיקום
- התאמה לשעון קיץ/חורף אוטומטית
- חישובים מקצועיים (Hebcal)

### 11.3 גמישות
- תמיכה במגוון תצורות
- אפשרות התאמה אישית מלאה
- הוספת קבוצות דינמית

### 11.4 נוחות
- פקודות פשוטות ואינטואיטיביות
- הודעות ברורות בעברית
- אימוג'ים לזיהוי מהיר

### 11.5 אמינות
- ריצה רצופה 24/7
- רענון אוטומטי שבועי
- ניסיונות חוזרים במקרה של כשל

---

## 12. מגבלות ידועות

### 12.1 תלות בשירותים חיצוניים
- תלות ב-Hebcal API (אם השירות מושבת, אין זמנים)
- תלות ב-Telegram API

### 12.2 הגדרת מיקום ידנית
- המשתמש צריך למצוא את ה-GeoName ID בעצמו
- אין חיפוש מיקום אוטומטי

### 12.3 אין תמיכה בחגים (כרגע)
- הבוט עובד רק עם שבתות
- לא נועל בחגים שאינם שבת

### 12.4 דורש הרשאות אדמין בטלגרם
- הבוט חייב להיות אדמין בקבוצה
- ללא הרשאות אדמין - לא יכול לפעול

---

## 13. כיווני פיתוח עתידיים אפשריים

### 13.1 תמיכה בחגים
- זיהוי אוטומטי של חגים
- נעילה בחגים גם אם הם לא בשבת
- התאמה לחוגי ישראל ותפוצות

### 13.2 חיפוש מיקום אוטומטי
- הזנת שם עיר והבוט מוצא את ה-GeoName ID
- רשימה של ערים נפוצות

### 13.3 דוחות וסטטיסטיקות
- כמה פעמים הקבוצה ננעלה/נפתחה
- היסטוריית פעולות
- נוכחות משתמשים

### 13.4 הודעות תזכורת
- תזכורת לפני כניסת שבת (30 דקות לפני)
- הודעת זכור ושמור

### 13.5 ממשק ניהול web
- ניהול קבוצות דרך דף אינטרנט
- צפייה בלוגים
- שינוי הגדרות בממשק גרפי

### 13.6 תמיכה רב-לשונית
- אנגלית
- צרפתית
- ספרדית
- וכו'

### 13.7 הגדרות מתקדמות
- נעילה חלקית (הרשאות שונות למשתמשים שונים)
- רשימת הרשאות מותאמת
- חריגים למשתמשים מסוימים

---

## 14. סיכום

בוט "שומר שבת" הוא פתרון אוטומטי, גמיש ואמין לניהול קבוצות טלגרם בשבת. הוא מספק:

- ✅ **אוטומציה מלאה** - נעילה ופתיחה אוטומטית לפי זמני שבת
- ✅ **דיוק** - זמנים מדויקים לפי מיקום גיאוגרפי
- ✅ **גמישות** - תמיכה בקבוצה יחידה או מרובת קבוצות
- ✅ **נוחות** - פקודות פשוטות וברורות
- ✅ **אבטחה** - הפרדת הרשאות בין משתמשים למנהלים
- ✅ **אמינות** - ריצה רצופה ורענון אוטומטי

הבוט מתאים למשפחות, קהילות, ארגונים וכל מי שמחפש דרך נוחה לשמור על אווירת שבת בקבוצות הטלגרם שלו.

---

**סוף מסמך האיפיון**