# 🕯️ בוט "שומר שבת" לטלגרם

בוט אוטומטי שנועל את קבוצת הטלגרם שלך בכניסת שבת ופותח אותה בצאת השבת.

## ✨ תכונות

- 🔒 **נעילה אוטומטית** בזמן הדלקת נרות
- 🔓 **פתיחה אוטומטית** בזמן הבדלה
- 📍 **תמיכה בכל מיקום** בעולם (דרך GeoNames)
- 🔄 **רענון שבועי** אוטומטי של זמני שבת
- 💬 **הודעות מותאמות אישית**
- 🧩 **תמיכה בריבוי קבוצות/מיקומים** (באמצעות GROUPS_CONFIG)
- 🤖 **פקודות ניהול** לאדמינים
- ☁️ **פריסה חינמית** על Render

## 🎮 פקודות הבוט

### 📋 פקודות כלליות (כל משתמש):

| פקודה | תיאור |
|-------|--------|
| `/start` | הודעת ברוכים הבאים ומידע על הבוט |
| `/times` | הצגת זמני השבת הקרובה (הדלקת נרות והבדלה) |
| `/status` | סטטוס הבוט והתזמונים הקרובים |
| `/help` | עזרה ומידע על הפקודות |

### 🔐 פקודות אדמין (רק למנהלי הקבוצה):

| פקודה | תיאור |
|-------|--------|
| `/lock` | נעילה ידנית של הקבוצה (לשעת חירום) |
| `/unlock` | פתיחה ידנית של הקבוצה |
| `/settings` | הצגת הגדרות הבוט (מיקום, זמנים, הודעות) |
| `/admin_help` | עזרה והסברים מפורטים לפקודות אדמין |
| **🌍 הגדרת מיקום (3 דרכים):** ||
| `/cities` | **הצגת רשימת ערים נפוצות (הדרך הכי פשוטה!)** ⭐ |
| `/setcity <מספר או שם>` | בחירת עיר מהרשימה (דוגמה: `/setcity 1` או `/setcity ירושלים`) |
| `/searchcity <שם-עיר>` | חיפוש עיר חדשה והצגת תוצאות לבחירה |
| `/setgeo <GEONAME_ID> [שם-מיקום]` | הגדרת מיקום ידנית (למתקדמים) |
| `/findgeo <שם-עיר>` | חיפוש מזהה GeoName (זהה ל-searchcity) |
| **⚙️ הגדרות מתקדמות:** ||
| `/setoffsets <CANDLE_MIN> [HAVDALAH_MIN]` | עדכון דקות הדלקה/הבדלה |
| `/setmessages <LOCK> || <UNLOCK>` | עדכון הודעות נעילה/פתיחה |

**💡 טיפ:** הפקודות `/lock` ו-`/unlock` שימושיות במקרים מיוחדים, למשל:
- שבת שנכנסת מוקדם (ערב חג)
- צורך לפתוח זמנית את הקבוצה לשעת חירום
- בדיקה שהבוט עובד תקין

## 🚀 התקנה מהירה

### 1️⃣ יצירת הבוט בטלגרם

1. פתח שיחה עם [@BotFather](https://t.me/BotFather)
2. שלח `/newbot` וענה על השאלות
3. שמור את הטוקן שקיבלת (נראה כך: `1234567890:ABCdef...`)

### 2️⃣ הוספת הבוט לקבוצה

1. צור קבוצה חדשה או בחר קיימת
2. הוסף את הבוט לקבוצה
3. **חשוב:** הפוך את הבוט ל-**Admin** עם הרשאות:
   - ✅ Change Group Info
   - ✅ Delete Messages
   - ✅ Restrict Members

### 3️⃣ מציאת ה-ID של הקבוצה

1. הוסף את [@getidsbot](https://t.me/getidsbot) לקבוצה
2. הבוט יתן לך את ה-ID של הקבוצה (מתחיל עם `-100...`)
3. שמור את המספר הזה

### 4️⃣ העלאה ל-Render

#### א. הכנת הקוד

```bash
# שכפל את הפרויקט
git clone <your-repo-url>
cd shabbat-bot

# צור קובץ .env מקומי (לבדיקות)
cp .env.example .env
# ערוך את .env עם הערכים האמיתיים
```

#### ב. יצירת Service ב-Render

1. היכנס ל-[Render Dashboard](https://dashboard.render.com/)
2. לחץ **New +** → **Background Worker**
3. חבר את ה-repository שלך מ-GitHub
4. הגדרות:
   - **Name:** `shabbat-bot` (או כל שם שתרצה)
   - **Environment:** `Python 3`
   - **Build Command:** `pip install -r requirements.txt`
   - **Start Command:** משאיר ריק (Render ישתמש ב-Procfile)

#### ג. הוספת משתני סביבה ב-Render

לחץ על **Environment** והוסף את `TELEGRAM_BOT_TOKEN`. לאחר מכן בחר אחת מהאפשרויות:

##### אפשרות א: קבוצה אחת (פשוט ומהיר)

הוסף את המשתנים הבאים:

| Key | Value | דוגמה |
|-----|-------|--------|
| `TELEGRAM_BOT_TOKEN` | הטוקן מ-BotFather | `1234567890:ABC...` |
| `CHAT_ID` | ID של הקבוצה | `-1001234567890` |
| `GEONAME_ID` | מזהה המיקום | `281184` (ירושלים) |
| `LOCATION` | שם המיקום | `Jerusalem` |

**אופציונלי:**
- `CANDLE_LIGHTING_OFFSET` - דקות לפני שקיעה (ברירת מחדל: 18)
- `HAVDALAH_OFFSET` - דקות אחרי שקיעה (ברירת מחדל: 0 = אוטומטי)
- `LOCK_MESSAGE` - הודעה בכניסת שבת
- `UNLOCK_MESSAGE` - הודעה בצאת שבת

##### אפשרות ב: ריבוי קבוצות/מיקומים (אינסטנס אחד לכמה קבוצות)

במקום המשתנים של אפשרות א (לא צריך `CHAT_ID/GEONAME_ID/LOCATION`), הוסף משתנה אחד:

- `GROUPS_CONFIG` — ערך מסוג JSON של מערך קבוצות. דוגמה:

```json
[
  {
    "chat_id": "-1001234567890",
    "location": "Jerusalem",
    "geoname_id": "281184",
    "candle_lighting_offset": 18,
    "havdalah_offset": 0,
    "lock_message": "🕯️ שבת שלום!",
    "unlock_message": "✨ שבוע טוב!"
  },
  {
    "chat_id": "-1009876543210",
    "location": "Tel Aviv",
    "geoname_id": "293397",
    "candle_lighting_offset": 18,
    "havdalah_offset": 0
  }
]
```

הערות:
- אם הוגדר `GROUPS_CONFIG`, אין צורך ב-`CHAT_ID/GEONAME_ID/LOCATION` (עדיין חובה `TELEGRAM_BOT_TOKEN`).
- ניתן לשלב שדות ברירת מחדל גלובליים; כל שדה חסר בקבוצה יירש ברירת מחדל מהגלובלי.

##### אפשרות ג: דינמי לחלוטין — בלי להגדיר קבוצות מראש

- הגדר רק `TELEGRAM_BOT_TOKEN`.
- הוסף את הבוט לכל קבוצה שבה תרצה להשתמש.
- אדמין הקבוצה יריץ:
  - `/setgeo <GEONAME_ID> [שם-מיקום]`
  - אופציונלי: `/setoffsets <CANDLE_MIN> [HAVDALAH_MIN]`
  - אופציונלי: `/setmessages <LOCK> || <UNLOCK>`
- ההגדרות נשמרות בקובץ `groups.json` לצד האפליקציה, והתזמונים יוגדרו אוטומטית.

#### ד. פריסה

1. לחץ **Create Background Worker**
2. Render יתחיל לבנות ולהריץ את הבוט
3. בדוק ב-**Logs** שהבוט פועל תקין

## 🔍 מציאת מיקום למיקום שלך

### 🌟 דרך 1: שימוש ברשימת ערים נפוצות (הכי קל!)

הבוט כולל רשימה מובנית של ערים נפוצות. פשוט:
1. שלח `/cities` בקבוצה
2. שלח `/setcity <מספר>` או `/setcity <שם-עיר>`
   - לדוגמה: `/setcity 1` או `/setcity ירושלים`

**ערים נפוצות כלולות ברשימה:**
- 🇮🇱 ישראל: ירושלים, תל אביב, חיפה, באר שבע, פתח תקווה, נתניה, אשדוד
- 🇺🇸 ארה"ב: ניו יורק, לוס אנג'לס, מיאמי
- 🌍 אחרות: לונדון, פריז

### 🔍 דרך 2: חיפוש עיר חדשה

שלח `/searchcity <שם-עיר>` והבוט יציג לך תוצאות לבחירה.
- דוגמה: `/searchcity Jerusalem` או `/searchcity תל אביב`

### 🔧 דרך 3: הגדרה ידנית של GeoName ID

1. היכנס ל-[GeoNames.org](https://www.geonames.org/)
2. חפש את העיר שלך
3. לחץ על התוצאה
4. ה-ID מופיע ב-URL: `geonames.org/XXXXXXX`
5. שלח `/setgeo <ID> [שם-עיר]`

| עיר | GeoName ID |
|-----|-----------|
| ירושלים | 281184 |
| תל אביב | 293397 |
| חיפה | 294801 |
| באר שבע | 295530 |
| פתח תקווה | 293322 |
| נתניה | 293619 |
| אשדוד | 295629 |

## 📁 מבנה הפרויקט

```
shabbat-bot/
├── bot.py                 # קוד ראשי
├── config.py             # הגדרות
├── shabbat_times.py      # משיכת זמני שבת
├── requirements.txt      # תלויות
├── Procfile             # הגדרות Render
├── .env.example         # תבנית משתני סביבה
├── .gitignore           # קבצים להתעלם
└── README.md            # התיעוד הזה
```

## 🧪 בדיקה מקומית

```bash
# התקנת תלויות
pip install -r requirements.txt

# הרצת הבוט
python bot.py

# בדיקת משיכת זמני שבת
python shabbat_times.py
```

## 🔧 פתרון בעיות

### הבוט לא נועל את הקבוצה?

- ✅ בדוק שהבוט הוא **Admin** בקבוצה
- ✅ בדוק שהבוט קיבל הרשאות **Restrict Members**
- ✅ בדוק ב-Logs של Render שאין שגיאות

### זמני השבת לא נכונים?

- ✅ ודא שה-`GEONAME_ID` נכון למיקום שלך
- ✅ בדוק את ההגדרות ב-[Hebcal.com](https://www.hebcal.com/shabbat)

### הבוט לא עובד אחרי deployment?

- ✅ ודא שכל משתני הסביבה הוזנו ב-Render
- ✅ בדוק ב-**Logs** של Render מה השגיאה
- ✅ ודא שהבוט פועל כ-**Background Worker** (לא Web Service)

## 📝 לוגים

כדי לראות את הלוגים של הבוט:

1. היכנס ל-Render Dashboard
2. בחר את ה-service שלך
3. לחץ **Logs**

תראה הודעות כמו:
```
✅ הגדרות נטענו בהצלחה!
✅ מחובר כ: @your_bot_username
⏰ תוזמן נעילה: 2025-10-03 18:23
⏰ תוזמן פתיחה: 2025-10-04 19:45
```

## 🎨 התאמה אישית

### שינוי הודעות

ערוך את משתני הסביבה:
```
LOCK_MESSAGE=🌙 ערב שבת טוב! נתראה במוצ"ש
UNLOCK_MESSAGE=🌟 מוצאי שבת טוב!
```

### שינוי זמני הדלקה

```
CANDLE_LIGHTING_OFFSET=30  # 30 דקות לפני שקיעה
HAVDALAH_OFFSET=50         # 50 דקות אחרי שקיעה
```

## 🛡️ אבטחה

- ❌ **לעולם** אל תעלה את קובץ `.env` ל-Git
- ✅ השתמש רק במשתני סביבה של Render
- ✅ הבוט **לא** שומר מידע רגיש
- ✅ כל התקשורת מוצפנת (HTTPS/TLS)

## 📚 טכנולוגיות

- [python-telegram-bot](https://github.com/python-telegram-bot/python-telegram-bot) v22.5
- [APScheduler](https://github.com/agronholm/apscheduler) v3.11.0
- [Hebcal API](https://www.hebcal.com/home/developer-apis) - זמני שבת
- [Render](https://render.com/) - hosting חינמי

## 🤝 תרומה

מצאת באג? יש רעיון לשיפור? פתח Issue או Pull Request!

## 📄 רישיון

פרויקט זה הוא קוד פתוח ללא רישיון מגביל. תרגיש חופשי להשתמש, לשנות ולשתף!

## 💝 תודות

- תודה ל-[@BotFather](https://t.me/BotFather) על יצירת הבוטים
- תודה ל-[Hebcal](https://www.hebcal.com/) על ה-API המדהים
- תודה ל-[Render](https://render.com/) על ה-hosting החינמי

---

**שבת שלום! 🕯️✨**
